{% extends 'base.html' %}
{% load static %}

{% block title %}ÎˆÎ³Î³ÏÎ±Ï†Î± ÎšÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¯Î¿Ï… - Hoolie Pet Insurance{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title" style="font-size: 2.5rem; margin-bottom: 1rem;">
                <span style="background: linear-gradient(45deg, #ffffff, #f0f8ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Î‘Î½Î­Î²Î±ÏƒÏ„Îµ Ï„Î± Î­Î³Î³ÏÎ±Ï†Î± <span id="pet-name-in-title">Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï ÏƒÎ±Ï‚</span> ğŸ“„
                </span>
            </h1>
            
            <p class="hero-subtitle" style="font-size: 1.1rem; margin-bottom: 3rem; opacity: 0.9;">
                Î§ÏÎµÎ¹Î±Î¶ÏŒÎ¼Î±ÏƒÏ„Îµ Ï„Î± Î­Î³Î³ÏÎ±Ï†Î± Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎ¿Ï…Î¼Îµ
            </p>
            
            <!-- Pet Info Card -->
            <div class="pet-info-card" style="margin-bottom: 3rem;">
                <div class="pet-icon-small" id="pet-avatar">ğŸ•</div>
                <span class="pet-reminder-text" id="pet-name-display">Î¤Î¿ ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹ÏŒ ÏƒÎ±Ï‚</span>
                <span class="gender-indicator" id="pet-gender-display">
                    <span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>
                </span>
            </div>
            
            <!-- Document Upload Section -->
            <div class="document-upload-section">
                <div class="document-upload-card">
                    <div class="upload-header">
                        <div class="upload-icon">ğŸ“</div>
                        <h3>Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î•Î³Î³ÏÎ¬Ï†Ï‰Î½</h3>
                        <p>Î£ÏÏÎµÏ„Îµ ÎºÎ±Î¹ Î±Ï†Î®ÏƒÏ„Îµ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± ÎµÎ´Ï Î® ÎºÎ¬Î½Ï„Îµ ÎºÎ»Î¹Îº Î³Î¹Î± ÎµÏ€Î¹Î»Î¿Î³Î®</p>
                    </div>
                    
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="documentInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                        <div class="upload-content">
                            <div class="upload-icon-large">ğŸ“„</div>
                            <p class="upload-text">Î£ÏÏÎµÏ„Îµ Ï„Î± Î­Î³Î³ÏÎ±Ï†Î± ÎµÎ´Ï</p>
                            <p class="upload-subtext">Î®</p>
                            <button type="button" class="btn-upload" onclick="document.getElementById('documentInput').click()">
                                Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î‘ÏÏ‡ÎµÎ¯Î±
                            </button>
                            <p class="upload-hint">ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚: 10MB Î±Î½Î¬ Î±ÏÏ‡ÎµÎ¯Î¿<br>Î‘Ï€Î¿Î´ÎµÎºÏ„Î¬: PDF, JPG, PNG, DOC, DOCX</p>
                        </div>
                    </div>
                    
                    <!-- Uploaded Files List -->
                    <div class="uploaded-files" id="uploadedFiles" style="display: none;">
                        <h4>Î‘Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½Î± Î‘ÏÏ‡ÎµÎ¯Î±:</h4>
                        <ul id="filesList"></ul>
                    </div>
                    
                    <!-- Upload Status -->
                    <div class="upload-status" id="uploadStatus" style="display: none;">
                        <div class="status-message"></div>
                    </div>
                </div>
            </div>
            
            <!-- Photo Upload Section -->
            <div class="document-upload-section" style="margin-top: 3rem;">
                <div class="document-upload-card">
                    <div class="upload-header">
                        <div class="upload-icon">ğŸ“¸</div>
                        <h3>Î‘Î½Î­Î²Î±ÏƒÎ¼Î± Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¹ÏÎ½</h3>
                        <p>Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½ÎµÎ²Î¬ÏƒÏ„Îµ <strong>Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 5 Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚</strong> Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï ÏƒÎ±Ï‚ Î±Ï€ÏŒ Î´Î¹Î¬Ï†Î¿ÏÎµÏ‚ Î³Ï‰Î½Î¯ÎµÏ‚ (Ï€ÎµÏÎ¹Î¼ÎµÏ„ÏÎ¹ÎºÎ¬)</p>
                    </div>
                    
                    <div class="upload-area" id="photoUploadArea">
                        <input type="file" id="photoInput" multiple accept="image/jpeg,image/jpg,image/png,image/webp" style="display: none;">
                        <div class="upload-content">
                            <div class="upload-icon-large">ğŸ“·</div>
                            <p class="upload-text">Î£ÏÏÎµÏ„Îµ Ï„Î¹Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ ÎµÎ´Ï</p>
                            <p class="upload-subtext">Î®</p>
                            <button type="button" class="btn-upload" onclick="document.getElementById('photoInput').click()">
                                Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚
                            </button>
                            <p class="upload-hint">ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚: 10MB Î±Î½Î¬ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±<br>Î‘Ï€Î¿Î´ÎµÎºÏ„Î¬: JPG, PNG, WEBP<br><strong>Î‘Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹: Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 5 Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚</strong></p>
                        </div>
                    </div>
                    
                    <!-- Photo Counter -->
                    <div class="photo-counter" id="photoCounter" style="margin-top: 1.5rem; padding: 1rem; background: rgba(90, 200, 189, 0.1); border-radius: 10px; text-align: center;">
                        <p style="margin: 0; color: var(--brand-primary); font-weight: 600;">
                            <span id="photoCount">0</span> / 5 Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ (Î±Ï€Î±Î¹Ï„ÎµÎ¯Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 5)
                        </p>
                    </div>
                    
                    <!-- Uploaded Photos Grid -->
                    <div class="uploaded-photos" id="uploadedPhotos" style="display: none; margin-top: 2rem;">
                        <h4>Î‘Î½ÎµÎ²Î±ÏƒÎ¼Î­Î½ÎµÏ‚ Î¦Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚:</h4>
                        <div class="photos-grid" id="photosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;"></div>
                    </div>
                    
                    <!-- Photo Upload Status -->
                    <div class="upload-status" id="photoUploadStatus" style="display: none;">
                        <div class="status-message"></div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="navigation-buttons" style="margin-top: 3rem;">
                <button class="btn btn-lg btn-light me-3" onclick="goBack()" style="padding: 1rem 2rem; border-radius: 15px; font-weight: 600;">
                    <i class="fas fa-arrow-left me-2"></i>
                    Î Î¯ÏƒÏ‰
                </button>
                <button class="btn btn-lg" id="continueBtn" onclick="continueToHealth()" disabled style="background: #ccc; border: none; color: white; padding: 1rem 2rem; border-radius: 15px; font-weight: 600; cursor: not-allowed;">
                    Î•Ï€ÏŒÎ¼ÎµÎ½Î¿
                    <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</section>

<style>
.document-upload-section {
    max-width: 800px;
    margin: 0 auto 3rem;
}

.document-upload-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 10px 40px rgba(90, 200, 189, 0.2);
    backdrop-filter: blur(10px);
}

.upload-header {
    text-align: center;
    margin-bottom: 2rem;
}

.upload-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.upload-header h3 {
    font-size: 1.8rem;
    color: var(--brand-primary);
    margin-bottom: 0.5rem;
}

.upload-header p {
    color: #666;
    font-size: 1rem;
}

.upload-area {
    border: 3px dashed #5ac8bd;
    border-radius: 15px;
    padding: 3rem 2rem;
    text-align: center;
    background: rgba(90, 200, 189, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-area:hover {
    border-color: #4a9e94;
    background: rgba(90, 200, 189, 0.1);
}

.upload-area.dragover {
    border-color: #4a9e94;
    background: rgba(90, 200, 189, 0.15);
    transform: scale(1.02);
}

.upload-content {
    width: 100%;
}

.upload-icon-large {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.upload-text {
    font-size: 1.3rem;
    color: var(--brand-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.upload-subtext {
    color: #999;
    margin: 0.5rem 0;
}

.btn-upload {
    background: var(--brand-gradient);
    color: white;
    border: none;
    padding: 1rem 2.5rem;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    margin: 1rem 0;
    box-shadow: 0 5px 15px rgba(90, 200, 189, 0.3);
    transition: all 0.3s ease;
}

.btn-upload:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(90, 200, 189, 0.4);
}

.upload-hint {
    color: #999;
    font-size: 0.9rem;
    margin-top: 1rem;
}

.uploaded-files {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #e0e0e0;
}

.uploaded-files h4 {
    color: var(--brand-primary);
    margin-bottom: 1rem;
}

.uploaded-files ul {
    list-style: none;
    padding: 0;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 10px;
    margin-bottom: 0.5rem;
}

.file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.file-icon {
    font-size: 1.5rem;
}

.file-name {
    font-weight: 500;
    color: #333;
}

.file-size {
    color: #999;
    font-size: 0.9rem;
}

.remove-file {
    background: #dc3545;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
}

.remove-file:hover {
    background: #c82333;
}

.upload-status {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 10px;
}

.upload-status.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.upload-status.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.upload-status.info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

#continueBtn:not(:disabled) {
    background: var(--brand-gradient);
    cursor: pointer;
}

#continueBtn:not(:disabled):hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(90, 200, 189, 0.4);
}
</style>

<script>
let uploadedFiles = [];
let uploadedPhotos = [];

document.addEventListener('DOMContentLoaded', function() {
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const name = urlParams.get('name');
    
    // Set pet summary information
    if (petType === 'dog') {
        document.getElementById('pet-avatar').textContent = 'ğŸ•';
    } else if (petType === 'cat') {
        document.getElementById('pet-avatar').textContent = 'ğŸ±';
    }
    
    // Set pet name
    if (name) {
        const petName = decodeURIComponent(name);
        document.getElementById('pet-name-display').textContent = petName;
        document.getElementById('pet-name-in-title').textContent = `Ï„Î¿Ï… ${petName}`;
    }
    
    // Set gender display
    if (gender === 'male') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>';
    } else if (gender === 'female') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #E91E63;">â™€ï¸ Î˜Î·Î»Ï…ÎºÏŒ</span>';
    }
    
    // Setup file input
    const fileInput = document.getElementById('documentInput');
    const uploadArea = document.getElementById('uploadArea');
    
    // Click to upload
    uploadArea.addEventListener('click', () => {
        fileInput.click();
    });
    
    // File selection
    fileInput.addEventListener('change', function(e) {
        handleFiles(e);
        // Reset input value so the same file can be selected again
        e.target.value = '';
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handleFileSelection(files);
    });
    
    // Setup photo input
    const photoInput = document.getElementById('photoInput');
    const photoUploadArea = document.getElementById('photoUploadArea');
    
    // Click to upload photos
    photoUploadArea.addEventListener('click', () => {
        photoInput.click();
    });
    
    // Photo selection
    photoInput.addEventListener('change', handlePhotos);
    
    // Drag and drop for photos
    photoUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        photoUploadArea.classList.add('dragover');
    });
    
    photoUploadArea.addEventListener('dragleave', () => {
        photoUploadArea.classList.remove('dragover');
    });
    
    photoUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        photoUploadArea.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files);
        handlePhotoSelection(files);
    });
    
    // Update photo counter on load
    updatePhotoCounter();
});

function handleFiles(e) {
    const files = Array.from(e.target.files);
    handleFileSelection(files);
}

function handleFileSelection(files) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    files.forEach(file => {
        // Validate file size
        if (file.size > maxSize) {
            showStatus('error', `Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ "${file.name}" Ï…Ï€ÎµÏÎ²Î±Î¯Î½ÎµÎ¹ Ï„Î¿ ÏŒÏÎ¹Î¿ 10MB`);
            return;
        }
        
        // Validate file type
        if (!file.type || !allowedTypes.includes(file.type)) {
            showStatus('error', `Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ "${file.name}" Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿Î´ÎµÎºÏ„Î¿Ï Ï„ÏÏ€Î¿Ï…`);
            return;
        }
        
        // Upload file to server
        uploadFileToServer(file);
    });
}

function uploadFileToServer(file) {
    // Get pet information from URL
    const urlParams = new URLSearchParams(window.location.search);
    const petName = urlParams.get('name') || '';
    const petType = urlParams.get('type') || '';
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('pet_name', petName);
    formData.append('pet_type', petType);
    
    // Get CSRF token
    const csrfToken = getCookie('csrftoken');
    
    // Show uploading status
    showStatus('info', `Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ${file.name}...`);
    
    // Upload to server
    fetch('{% url "main:upload_pet_document" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        // Check if response is OK
        if (!response.ok) {
            // Try to parse error response
            return response.json().then(data => {
                throw new Error(data.error || `Server error: ${response.status}`);
            }).catch(() => {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success === true || data.success === 'true') {
            // Add to uploaded files list with server response
            // Ensure file.type is preserved
            uploadedFiles.push({
                name: file.name,
                size: file.size,
                type: file.type || 'application/octet-stream',
                document_id: data.document_id,
                file_url: data.file_url,
                uploaded: true
            });
            displayUploadedFiles();
            updateContinueButton();
            showStatus('success', data.message || 'Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î±Î½Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚');
        } else {
            showStatus('error', data.error || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î±');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showStatus('error', error.message || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î± Ï„Î¿Ï… Î±ÏÏ‡ÎµÎ¯Î¿Ï…');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function displayUploadedFiles() {
    const filesList = document.getElementById('filesList');
    const uploadedFilesDiv = document.getElementById('uploadedFiles');
    
    filesList.innerHTML = '';
    
    if (uploadedFiles.length > 0) {
        uploadedFilesDiv.style.display = 'block';
        
        uploadedFiles.forEach((file, index) => {
            const li = document.createElement('li');
            li.className = 'file-item';
            
            const fileIcon = getFileIcon(file.type || '');
            const fileSize = formatFileSize(file.size || 0);
            
            li.innerHTML = `
                <div class="file-info">
                    <span class="file-icon">${fileIcon}</span>
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                </div>
                <button type="button" class="remove-file" onclick="removeFile(${index})">Î‘Ï†Î±Î¯ÏÎµÏƒÎ·</button>
            `;
            
            filesList.appendChild(li);
        });
        
        showStatus('success', `Î•Ï€Î¹Ï„Ï…Ï‡ÏÏ‚ Ï€ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎ±Î½ ${uploadedFiles.length} Î±ÏÏ‡ÎµÎ¯Î±`);
    } else {
        uploadedFilesDiv.style.display = 'none';
    }
}

function getFileIcon(fileType) {
    if (!fileType) return 'ğŸ“';
    const type = fileType.toLowerCase();
    if (type.includes('pdf')) return 'ğŸ“„';
    if (type.includes('image')) return 'ğŸ–¼ï¸';
    if (type.includes('word') || type.includes('document')) return 'ğŸ“';
    return 'ğŸ“';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    displayUploadedFiles();
    updateContinueButton();
}

function updateContinueButton() {
    const continueBtn = document.getElementById('continueBtn');
    // Require at least 1 document AND at least 5 photos
    if (uploadedFiles.length > 0 && uploadedPhotos.length >= 5) {
        continueBtn.disabled = false;
        continueBtn.style.background = 'var(--brand-gradient)';
        continueBtn.style.cursor = 'pointer';
    } else {
        continueBtn.disabled = true;
        continueBtn.style.background = '#ccc';
        continueBtn.style.cursor = 'not-allowed';
    }
}

// Photo upload functions
function handlePhotos(e) {
    const files = Array.from(e.target.files);
    handlePhotoSelection(files);
    // Reset input value so the same file can be selected again
    e.target.value = '';
}

function handlePhotoSelection(files) {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    
    files.forEach(file => {
        // Validate file size
        if (file.size > maxSize) {
            showPhotoStatus('error', `Î— Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± "${file.name}" Ï…Ï€ÎµÏÎ²Î±Î¯Î½ÎµÎ¹ Ï„Î¿ ÏŒÏÎ¹Î¿ 10MB`);
            return;
        }
        
        // Validate file type
        if (!file.type || !allowedTypes.includes(file.type)) {
            showPhotoStatus('error', `Î— Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± "${file.name}" Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î¿Î´ÎµÎºÏ„Î¿Ï Ï„ÏÏ€Î¿Ï…`);
            return;
        }
        
        // Upload photo to server
        uploadPhotoToServer(file);
    });
}

function uploadPhotoToServer(file) {
    // Get pet information from URL
    const urlParams = new URLSearchParams(window.location.search);
    const petName = urlParams.get('name') || '';
    const petType = urlParams.get('type') || '';
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('pet_name', petName);
    formData.append('pet_type', petType);
    
    // Get CSRF token
    const csrfToken = getCookie('csrftoken');
    
    // Show uploading status
    showPhotoStatus('info', `Î‘Î½Î­Î²Î±ÏƒÎ¼Î± ${file.name}...`);
    
    // Upload to server
    fetch('{% url "main:upload_pet_photo" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        // Check if response is OK
        if (!response.ok) {
            // Try to parse error response
            return response.json().then(data => {
                throw new Error(data.error || `Server error: ${response.status}`);
            }).catch(() => {
                throw new Error(`Server error: ${response.status} ${response.statusText}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success === true || data.success === 'true') {
            // Add to uploaded photos list with server response
            uploadedPhotos.push({
                name: file.name,
                size: file.size,
                type: file.type || 'image/jpeg',
                photo_id: data.photo_id,
                file_url: data.file_url,
                uploaded: true
            });
            displayUploadedPhotos();
            updatePhotoCounter();
            updateContinueButton();
            showPhotoStatus('success', data.message || 'Î— Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î± Î±Î½Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚');
        } else {
            showPhotoStatus('error', data.error || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î±');
        }
    })
    .catch(error => {
        console.error('Photo upload error:', error);
        showPhotoStatus('error', error.message || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î± Ï„Î·Ï‚ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯Î±Ï‚');
    });
}

function displayUploadedPhotos() {
    const photosGrid = document.getElementById('photosGrid');
    const uploadedPhotosDiv = document.getElementById('uploadedPhotos');
    
    photosGrid.innerHTML = '';
    
    if (uploadedPhotos.length > 0) {
        uploadedPhotosDiv.style.display = 'block';
        
        uploadedPhotos.forEach((photo, index) => {
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-item';
            photoDiv.style.cssText = 'position: relative; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
            
            // Ensure URL is absolute and valid
            let imageUrl = photo.file_url || '';
            if (imageUrl) {
                if (!imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
                    // If relative URL, make it absolute
                    if (imageUrl.startsWith('/')) {
                        imageUrl = window.location.origin + imageUrl;
                    } else {
                        imageUrl = window.location.origin + '/' + imageUrl;
                    }
                }
            } else {
                // Fallback placeholder if no URL
                imageUrl = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'150\'%3E%3Crect fill=\'%23ddd\' width=\'150\' height=\'150\'/%3E%3Ctext fill=\'%23999\' font-family=\'sans-serif\' font-size=\'14\' dy=\'10.5\' font-weight=\'bold\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\'%3ENo Image%3C/text%3E%3C/svg%3E';
            }
            
            photoDiv.innerHTML = `
                <img src="${imageUrl}" alt="${photo.name}" style="width: 100%; height: 150px; object-fit: cover; display: block;" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'150\\' height=\\'150\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'150\\' height=\\'150\\'/%3E%3Ctext fill=\\'%23999\\' font-family=\\'sans-serif\\' font-size=\\'14\\' dy=\\'10.5\\' font-weight=\\'bold\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\'%3EError%3C/text%3E%3C/svg%3E'; console.error('Failed to load image:', '${imageUrl}');">
                <button type="button" class="remove-photo" onclick="removePhoto(${index})" style="position: absolute; top: 5px; right: 5px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">Ã—</button>
            `;
            
            photosGrid.appendChild(photoDiv);
        });
    } else {
        uploadedPhotosDiv.style.display = 'none';
    }
}

function removePhoto(index) {
    uploadedPhotos.splice(index, 1);
    displayUploadedPhotos();
    updatePhotoCounter();
    updateContinueButton();
}

function updatePhotoCounter() {
    const photoCount = document.getElementById('photoCount');
    const count = uploadedPhotos.length;
    photoCount.textContent = count;
    
    // Update counter color based on requirement
    const counterDiv = document.getElementById('photoCounter');
    if (count >= 5) {
        counterDiv.style.background = 'rgba(40, 167, 69, 0.1)';
        counterDiv.querySelector('p').style.color = '#28a745';
    } else {
        counterDiv.style.background = 'rgba(90, 200, 189, 0.1)';
        counterDiv.querySelector('p').style.color = 'var(--brand-primary)';
    }
}

function showPhotoStatus(type, message) {
    const statusDiv = document.getElementById('photoUploadStatus');
    statusDiv.className = `upload-status ${type}`;
    statusDiv.style.display = 'block';
    statusDiv.querySelector('.status-message').textContent = message;
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function showStatus(type, message) {
    const statusDiv = document.getElementById('uploadStatus');
    statusDiv.className = `upload-status ${type}`;
    statusDiv.style.display = 'block';
    statusDiv.querySelector('.status-message').textContent = message;
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

function continueToHealth() {
    // Check if all files have been uploaded
    const allFilesUploaded = uploadedFiles.every(f => f.uploaded === true);
    const allPhotosUploaded = uploadedPhotos.every(p => p.uploaded === true);
    
    if (uploadedFiles.length === 0) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± Î­Î³Î³ÏÎ±Ï†Î¿ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ.');
        return;
    }
    
    if (uploadedPhotos.length < 5) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 5 Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¯ÎµÏ‚ Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÏ„Îµ.');
        return;
    }
    
    if (!allFilesUploaded) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½.');
        return;
    }
    
    if (!allPhotosUploaded) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯ Ï„Î¿ Î±Î½Î­Î²Î±ÏƒÎ¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ Ï†Ï‰Ï„Î¿Î³ÏÎ±Ï†Î¹ÏÎ½.');
        return;
    }
    
    // Get all parameters
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const birthdate = urlParams.get('birthdate');
    const breed = urlParams.get('breed');
    const name = urlParams.get('name');
    
    // Navigate to health status page
    window.location.href = `{% url 'main:health_status' %}?type=${petType}&gender=${gender}&birthdate=${encodeURIComponent(birthdate)}&breed=${encodeURIComponent(breed)}&name=${encodeURIComponent(name)}`;
}

function goBack() {
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const birthdate = urlParams.get('birthdate');
    const breed = urlParams.get('breed');
    
    window.location.href = `{% url 'main:pet_name' %}?type=${petType}&gender=${gender}&birthdate=${encodeURIComponent(birthdate)}&breed=${encodeURIComponent(breed)}`;
}
</script>
{% endblock %}

