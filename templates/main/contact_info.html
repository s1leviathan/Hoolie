{% extends 'base.html' %}
{% load static %}

{% block title %}Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î•Ï€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î¯Î±Ï‚ - Hoolie Pet Insurance{% endblock %}

{% block content %}
{% csrf_token %}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title" style="font-size: 2.5rem; margin-bottom: 1rem;">
                <span style="background: linear-gradient(45deg, #ffffff, #f0f8ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Î£Ï‡ÎµÎ´ÏŒÎ½ Ï„ÎµÎ»ÎµÎ¹ÏÏƒÎ±Î¼Îµ! ğŸ‰
                </span>
            </h1>
            
            <p class="hero-subtitle" style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">
                Î— Î¿Î¼Î¬Î´Î± Ï„Î·Ï‚ Hoolie Î¸Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎµÎ¹ Î¼Î±Î¶Î¯ ÏƒÎ±Ï‚ Î³Î¹Î± Î­Î½Î± ÎµÎ¾Î±Ï„Î¿Î¼Î¹ÎºÎµÏ…Î¼Î­Î½Î¿ Ï€Î±ÎºÎ­Ï„Î¿ Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎ·Ï‚ <span id="pet-name-in-subtitle">Î³Î¹Î± Ï„Î¿ ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹ÏŒ ÏƒÎ±Ï‚</span>
            </p>
            
            <!-- Pet Info Card -->
            <div class="pet-info-card" style="margin-bottom: 3rem;">
                <div class="pet-icon-small" id="pet-avatar">ğŸ•</div>
                <span class="pet-reminder-text" id="pet-name-display">Î¤Î¿ ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹ÏŒ ÏƒÎ±Ï‚</span>
                <span class="gender-indicator" id="pet-gender-display">
                    <span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>
                </span>
            </div>
            
            <!-- Email Input Form -->
            <div class="email-form-container">
                <div class="form-card">
                    <div class="form-header">
                        <h3 style="margin-bottom: 1rem; font-weight: 600;">
                            ğŸ“§ Î ÏÏ‚ Î¼Ï€Î¿ÏÎ¿ÏÎ¼Îµ Î½Î± ÎµÏ€Î¹ÎºÎ¿Î¹Î½Ï‰Î½Î®ÏƒÎ¿Ï…Î¼Îµ Î¼Î±Î¶Î¯ ÏƒÎ±Ï‚;
                        </h3>
                        <p style="margin-bottom: 2rem;">
                            Î•Î¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚ Î³Î¹Î± Î½Î± Î»Î¬Î²ÎµÏ„Îµ Ï„Î·Î½ Ï€ÏÎ¿ÏƒÏ†Î¿ÏÎ¬ ÏƒÎ±Ï‚
                        </p>
                    </div>
                    
                    <div class="email-input-group">
                        <label for="email-input" class="form-label">Email Address *</label>
                        <input 
                            type="email" 
                            id="email-input" 
                            class="form-control email-input" 
                            placeholder="Ï€.Ï‡. yourname@example.com"
                            required
                        >
                        <div class="input-feedback" id="email-feedback"></div>
                    </div>
                    
                    <div class="privacy-notice" style="margin: 1.5rem 0;">
                        <small style="font-size: 0.9rem;">
                            ğŸ”’ Î¤Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÏƒÎ±Ï‚ ÎµÎ¯Î½Î±Î¹ Î±ÏƒÏ†Î±Î»Î® ÎºÎ±Î¹ Î´ÎµÎ½ Î¸Î± Î¼Î¿Î¹ÏÎ±ÏƒÏ„Î¿ÏÎ½ Î¼Îµ Ï„ÏÎ¯Ï„Î¿Ï…Ï‚
                        </small>
                    </div>
                    
                    <button 
                        class="btn btn-primary btn-lg submit-email-btn" 
                        onclick="submitEmail()"
                        style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600; border-radius: 15px;"
                    >
                        Î›Î®ÏˆÎ· Î ÏÎ¿ÏƒÏ†Î¿ÏÎ¬Ï‚ ğŸš€
                    </button>
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="navigation-buttons" style="margin-top: 3rem;">
                <button class="btn btn-lg btn-light me-3" onclick="goBack()" style="padding: 1rem 2rem; border-radius: 15px; font-weight: 600;">
                    â† Î Î¯ÏƒÏ‰
                </button>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const name = urlParams.get('name');
    const breed = urlParams.get('breed');
    
    // Set pet avatar and name
    if (petType === 'dog') {
        document.getElementById('pet-avatar').textContent = 'ğŸ•';
    } else if (petType === 'cat') {
        document.getElementById('pet-avatar').textContent = 'ğŸ±';
    }
    
    // Set pet name
    if (name) {
        const petName = decodeURIComponent(name);
        document.getElementById('pet-name-display').textContent = petName;
        
        // Update subtitle to include pet name
        document.getElementById('pet-name-in-subtitle').textContent = `Î³Î¹Î± ${petName}`;
    }
    
    // Set gender display
    if (gender === 'male') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>';
    } else if (gender === 'female') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #E91E63;">â™€ï¸ Î˜Î·Î»Ï…ÎºÏŒ</span>';
    }
    
    // Email validation
    const emailInput = document.getElementById('email-input');
    const emailFeedback = document.getElementById('email-feedback');
    
    emailInput.addEventListener('input', function() {
        const email = this.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (email === '') {
            emailFeedback.textContent = '';
            emailFeedback.className = 'input-feedback';
        } else if (emailRegex.test(email)) {
            emailFeedback.textContent = 'âœ… ÎˆÎ³ÎºÏ…ÏÎ¿ email';
            emailFeedback.className = 'input-feedback valid';
        } else {
            emailFeedback.textContent = 'âŒ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ email';
            emailFeedback.className = 'input-feedback invalid';
        }
    });
});

function submitEmail() {
    const emailInput = document.getElementById('email-input');
    const email = emailInput.value.trim();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (!email) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î¿ email ÏƒÎ±Ï‚');
        emailInput.focus();
        return;
    }
    
    if (!emailRegex.test(email)) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Î­Î³ÎºÏ…ÏÎ¿ email');
        emailInput.focus();
        return;
    }
    
    // Get all parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const birthdate = urlParams.get('birthdate');
    const breed = urlParams.get('breed');
    const name = urlParams.get('name');
    const healthStatus = urlParams.get('health_status');
    const conditions = urlParams.get('conditions');
    const affiliateCode = urlParams.get('affiliateCode') || localStorage.getItem('affiliateCode') || '';
    
    // Get all user data from URL
    const fullName = urlParams.get('fullName') || '';
    const afm = urlParams.get('afm') || '';
    const phone = urlParams.get('phone') || '';
    const address = urlParams.get('address') || '';
    const postalCode = urlParams.get('postalCode') || '';
    const microchip = urlParams.get('microchip') || '';
    const program = urlParams.get('program') || '';
    
    // Submit application via AJAX
    // Get CSRF token from cookie or meta tag
    let csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        // Try to get from meta tag if available
        const metaToken = document.querySelector('meta[name=csrf-token]');
        if (metaToken) {
            csrfToken = metaToken.getAttribute('content');
        } else {
            // Try to get from hidden input
            const csrfInput = document.querySelector('input[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            }
        }
    }
    
    if (!csrfToken) {
        alert('Î£Ï†Î¬Î»Î¼Î±: Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ CSRF token. Î Î±ÏÎ±ÎºÎ±Î»Ï Î±Î½Î±Î½ÎµÏÏƒÏ„Îµ Ï„Î· ÏƒÎµÎ»Î¯Î´Î±.');
        return;
    }
    
    // Prepare form data
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', csrfToken);
    
    // Add all form fields
    const fields = {
        'type': petType,
        'gender': gender,
        'birthdate': birthdate,
        'breed': breed,
        'name': name,
        'health_status': healthStatus,
        'conditions': conditions,
        'program': program,
        'fullName': fullName,
        'afm': afm,
        'phone': phone,
        'address': address,
        'postalCode': postalCode,
        'email': email,
        'microchip': microchip,
        'affiliateCode': affiliateCode
    };
    
    // Add second pet data if exists
    const secondPetName = urlParams.get('secondPetName');
    if (secondPetName) {
        formData.append('secondPetName', secondPetName);
        formData.append('secondPetType', urlParams.get('secondPetType') || '');
        formData.append('secondPetGender', urlParams.get('secondPetGender') || '');
        formData.append('secondPetBirthdate', urlParams.get('secondPetBirthdate') || '');
        formData.append('secondPetBreed', urlParams.get('secondPetBreed') || '');
        formData.append('secondPetWeight', urlParams.get('secondPetWeight') || '');
        formData.append('secondPetHealth', urlParams.get('secondPetHealthStatus') || '');
    }
    
    for (const [key, value] of Object.entries(fields)) {
        if (value) {
            formData.append(key, value);
        }
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[onclick="submitEmail()"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Î¥Ï€Î¿Î²Î¿Î»Î®...';
    
    // Submit via AJAX
    fetch('{% url "main:user_data" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect based on response
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            } else {
                // Fallback redirect
                window.location.href = '{% url "main:thank_you" %}';
            }
        } else {
            alert(data.message || 'Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î® Ï„Î·Ï‚ Î±Î¯Ï„Î·ÏƒÎ·Ï‚');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï…Ï€Î¿Î²Î¿Î»Î® Ï„Î·Ï‚ Î±Î¯Ï„Î·ÏƒÎ·Ï‚. Î Î±ÏÎ±ÎºÎ±Î»Ï Î´Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

function goBack() {
    window.history.back();
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
