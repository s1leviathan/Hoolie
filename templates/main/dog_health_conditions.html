{% extends 'base.html' %}
{% load static %}

{% block title %}Î ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Î¥Î³ÎµÎ¯Î±Ï‚ Î£ÎºÏÎ»Î¿Ï… - Î‘ÏƒÏ†Î¬Î»Î¹ÏƒÎ· Î¥Î³ÎµÎ¯Î±Ï‚{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title" style="font-size: 2.3rem; margin-bottom: 1rem;">
                <span style="background: linear-gradient(45deg, #ffffff, #f0f8ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î± Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Ï…Î³ÎµÎ¯Î±Ï‚ <span id="pet-name-in-title">Ï„Î¿Ï… ÏƒÎºÏÎ»Î¿Ï… ÏƒÎ±Ï‚</span>
                </span>
            </h1>
            
            <p class="hero-subtitle" style="font-size: 1rem; margin-bottom: 2rem; opacity: 0.9;">
                ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± ÎµÏ€Î¹Î»Î­Î¾ÎµÏ„Îµ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ Î±Ï€ÏŒ Î¼Î¯Î± ÎµÏ€Î¹Î»Î¿Î³Î­Ï‚
            </p>
            
            <!-- Pet Info Card -->
            <div class="pet-info-card" style="margin-bottom: 2rem;">
                <div class="pet-icon-small">ğŸ•</div>
                <span class="pet-reminder-text" id="pet-name-display">Î¤Î¿ ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹ÏŒ ÏƒÎ±Ï‚</span>
                <span class="gender-indicator" id="pet-gender-display">
                    <span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>
                </span>
            </div>
            
            <!-- Health Conditions Grid -->
            <div class="conditions-grid">
                {% for condition in conditions %}
                <div class="condition-item" data-condition="{{ condition }}" onclick="toggleCondition('{{ condition }}')">
                    <div class="condition-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="condition-text">{{ condition }}</span>
                </div>
                {% endfor %}
                
                <!-- Other option -->
                <div class="condition-item other-condition" data-condition="other" onclick="toggleOtherCondition()">
                    <div class="condition-checkbox">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="condition-text">Î†Î»Î»Î¿</span>
                </div>
            </div>
            
            <!-- Other condition input -->
            <div class="other-input-section" id="other-input-section" style="display: none;">
                <div class="other-input-card">
                    <h4 class="other-input-title">Î ÎµÏÎ¹Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± Ï…Î³ÎµÎ¯Î±Ï‚:</h4>
                    <textarea id="other-condition-text" class="other-condition-textarea" placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ ÎµÎ´Ï Ï„Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± Ï…Î³ÎµÎ¯Î±Ï‚ Ï€Î¿Ï… Î´ÎµÎ½ Î²ÏÎ¯ÏƒÎºÎµÏ„Î±Î¹ ÏƒÏ„Î· Î»Î¯ÏƒÏ„Î±..." maxlength="500"></textarea>
                    <div class="char-counter">
                        <span id="char-count">0</span>/500 Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚
                    </div>
                </div>
            </div>
            
            <!-- Selected conditions summary -->
            <div class="selected-conditions" id="selected-conditions" style="display: none;">
                <h4 class="selected-title">Î•Ï€Î¹Î»ÎµÎ³Î¼Î­Î½Î± Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Ï…Î³ÎµÎ¯Î±Ï‚:</h4>
                <div class="selected-list" id="selected-list">
                    <!-- Will be filled by JavaScript -->
                </div>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="navigation-buttons" style="margin-top: 3rem;">
                <button class="btn btn-lg btn-light me-3" onclick="goBack()" style="padding: 1rem 2rem; border-radius: 15px; font-weight: 600;">
                    <i class="fas fa-arrow-left me-2"></i>
                    Î Î¯ÏƒÏ‰
                </button>
                <button class="btn btn-lg" id="continue-btn" onclick="submitConditions()" style="background: var(--brand-gradient); border: none; color: white; padding: 1rem 2rem; border-radius: 15px; font-weight: 600; box-shadow: var(--shadow-soft); opacity: 0.5;" disabled>
                    Î•Ï€ÏŒÎ¼ÎµÎ½Î¿
                    <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
            
            <!-- Decorative elements -->
            <div class="floating-decorations">
                <div class="floating-element" style="top: 15%; left: 10%; font-size: 2rem;">ğŸ•â€ğŸ¦º</div>
                <div class="floating-element" style="top: 25%; right: 15%; font-size: 1.5rem;">ğŸ¥</div>
                <div class="floating-element" style="bottom: 30%; left: 20%; font-size: 2.5rem;">ğŸ’Š</div>
                <div class="floating-element" style="bottom: 20%; right: 10%; font-size: 1.8rem;">ğŸ©º</div>
                <div class="floating-element" style="top: 40%; left: 5%; font-size: 1.2rem;">â¤ï¸</div>
                <div class="floating-element" style="top: 60%; right: 5%; font-size: 1.4rem;">ğŸŒ¡ï¸</div>
            </div>
        </div>
    </div>
</section>

<script>
let selectedConditions = new Set();
let otherConditionSelected = false;

document.addEventListener('DOMContentLoaded', function() {
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const gender = urlParams.get('gender');
    const name = urlParams.get('name');
    
    // Set pet name
    if (name) {
        const petName = decodeURIComponent(name);
        document.getElementById('pet-name-display').textContent = petName;
        
        // Update title to include pet name
        document.getElementById('pet-name-in-title').textContent = `Ï„Î¿Ï… ${petName}`;
    }
    
    // Set gender display
    if (gender === 'male') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #4A90E2;">â™‚ï¸ Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ</span>';
    } else if (gender === 'female') {
        document.getElementById('pet-gender-display').innerHTML = '<span style="color: #E91E63;">â™€ï¸ Î˜Î·Î»Ï…ÎºÏŒ</span>';
    }
    
    // Add entrance animations
    const items = document.querySelectorAll('.condition-item');
    items.forEach((item, index) => {
        item.style.animation = `fadeInUp 0.8s ease-out ${0.1 + index * 0.05}s both`;
    });
    
    // Add character counter for other condition
    const textarea = document.getElementById('other-condition-text');
    const charCount = document.getElementById('char-count');
    
    textarea.addEventListener('input', function() {
        const count = this.value.length;
        charCount.textContent = count;
        
        if (count > 450) {
            charCount.style.color = '#e74c3c';
        } else if (count > 350) {
            charCount.style.color = '#f39c12';
        } else {
            charCount.style.color = '#666';
        }
    });
});

function toggleCondition(condition) {
    const item = document.querySelector(`[data-condition="${condition}"]`);
    
    if (selectedConditions.has(condition)) {
        selectedConditions.delete(condition);
        item.classList.remove('selected');
    } else {
        selectedConditions.add(condition);
        item.classList.add('selected');
    }
    
    updateSelectedSummary();
    updateContinueButton();
}

function toggleOtherCondition() {
    const item = document.querySelector('.other-condition');
    const otherSection = document.getElementById('other-input-section');
    
    if (otherConditionSelected) {
        otherConditionSelected = false;
        item.classList.remove('selected');
        otherSection.style.display = 'none';
    } else {
        otherConditionSelected = true;
        item.classList.add('selected');
        otherSection.style.display = 'block';
        otherSection.style.animation = 'fadeInUp 0.5s ease-out';
        
        // Focus on textarea
        setTimeout(() => {
            document.getElementById('other-condition-text').focus();
        }, 100);
    }
    
    updateSelectedSummary();
    updateContinueButton();
}

function updateSelectedSummary() {
    const selectedSection = document.getElementById('selected-conditions');
    const selectedList = document.getElementById('selected-list');
    
    if (selectedConditions.size > 0 || otherConditionSelected) {
        selectedSection.style.display = 'block';
        selectedSection.style.animation = 'fadeInUp 0.5s ease-out';
        
        selectedList.innerHTML = '';
        
        // Add selected conditions
        selectedConditions.forEach(condition => {
            const tag = document.createElement('span');
            tag.className = 'selected-tag';
            tag.textContent = condition;
            selectedList.appendChild(tag);
        });
        
        // Add other condition if selected
        if (otherConditionSelected) {
            const tag = document.createElement('span');
            tag.className = 'selected-tag other-tag';
            tag.textContent = 'Î†Î»Î»Î¿';
            selectedList.appendChild(tag);
        }
    } else {
        selectedSection.style.display = 'none';
    }
}

function updateContinueButton() {
    const continueBtn = document.getElementById('continue-btn');
    const hasSelections = selectedConditions.size > 0 || otherConditionSelected;
    
    if (hasSelections) {
        continueBtn.disabled = false;
        continueBtn.style.opacity = '1';
    } else {
        continueBtn.disabled = true;
        continueBtn.style.opacity = '0.5';
    }
}

function submitConditions() {
    if (selectedConditions.size === 0 && !otherConditionSelected) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î± Ï€ÏÏŒÎ²Î»Î·Î¼Î± Ï…Î³ÎµÎ¯Î±Ï‚.');
        return;
    }
    
    if (otherConditionSelected) {
        const otherText = document.getElementById('other-condition-text').value.trim();
        if (!otherText) {
            alert('Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ Î¬Î»Î»Î¿ Ï€ÏÏŒÎ²Î»Î·Î¼Î± Ï…Î³ÎµÎ¯Î±Ï‚.');
            document.getElementById('other-condition-text').focus();
            return;
        }
    }
    
    // Get all parameters
    const urlParams = new URLSearchParams(window.location.search);
    const petType = urlParams.get('type');
    const gender = urlParams.get('gender');
    const birthdate = urlParams.get('birthdate');
    const breed = urlParams.get('breed');
    const name = urlParams.get('name');
    
    // Prepare conditions list
    let conditionsList = Array.from(selectedConditions);
    if (otherConditionSelected) {
        const otherText = document.getElementById('other-condition-text').value.trim();
        conditionsList.push(`Î†Î»Î»Î¿: ${otherText}`);
    }
    
    // Add success animation
    const button = event.target;
    button.style.transform = 'scale(0.95)';
    button.innerHTML = '<i class="fas fa-check me-2"></i>Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±...';
    
    setTimeout(() => {
        // Check if this is second pet flow
        const secondPetFlow = urlParams.get('second_pet_flow');
        
        if (secondPetFlow === 'true') {
            // For second pet, go back to user_data with conditions
            const params = new URLSearchParams({
                // First pet data
                type: urlParams.get('first_pet_type') || '',
                gender: urlParams.get('first_pet_gender') || '',
                birthdate: urlParams.get('first_pet_birthdate') || '',
                breed: urlParams.get('first_pet_breed') || '',
                name: urlParams.get('first_pet_name') || '',
                health_status: urlParams.get('first_pet_health_status') || '',
                conditions: urlParams.get('first_pet_conditions') || '',
                program: urlParams.get('first_pet_program') || '',
                
                // Second pet data
                second_pet_type: petType || '',
                second_pet_gender: gender || '',
                second_pet_birthdate: birthdate || '',
                second_pet_breed: breed || '',
                second_pet_name: name || '',
                second_pet_health_status: 'problems',
                second_pet_conditions: conditionsList.join(', '),
                
                // User data
                fullName: urlParams.get('fullName') || '',
                afm: urlParams.get('afm') || '',
                phone: urlParams.get('phone') || '',
                address: urlParams.get('address') || '',
                postalCode: urlParams.get('postalCode') || '',
                email: urlParams.get('email') || '',
                microchip: urlParams.get('microchip') || ''
            });
            
            window.location.href = `{% url 'main:user_data' %}?${params.toString()}`;
        } else {
            // For first pet, navigate to contact info page with all data including conditions
            const params = new URLSearchParams({
                type: petType || '',
                gender: gender || '',
                birthdate: birthdate || '',
                breed: breed || '',
                name: name || '',
                health_status: 'problems',
                conditions: conditionsList.join(', ')
            });
            
            window.location.href = `{% url 'main:contact_info' %}?${params.toString()}`;
        }
    }, 1000);
}

function goBack() {
    const content = document.querySelector('.hero-content');
    content.style.animation = 'fadeOut 0.5s ease-in';
    
    setTimeout(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const petType = urlParams.get('type');
        const gender = urlParams.get('gender');
        const birthdate = urlParams.get('birthdate');
        const breed = urlParams.get('breed');
        const name = urlParams.get('name');
        
        window.location.href = `{% url "main:health_status" %}?type=${petType}&gender=${gender}&birthdate=${encodeURIComponent(birthdate)}&breed=${encodeURIComponent(breed)}&name=${encodeURIComponent(name)}`;
    }, 500);
}
</script>
{% endblock %}
