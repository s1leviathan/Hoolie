{% extends 'base.html' %}
{% load static %}

{% block title %}Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ - Hoolie Pet Insurance{% endblock %}

{% block content %}
<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1 class="hero-title" style="font-size: 2.5rem; margin-bottom: 1rem;">
                <span style="background: linear-gradient(45deg, #ffffff, #f0f8ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    Î•Ï€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Ï‰Î½ ğŸ“‹
                </span>
            </h1>
            
            <p class="hero-subtitle" style="font-size: 1.1rem; margin-bottom: 3rem; opacity: 0.9;">
                Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ»Î­Î³Î¾Ï„Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± <span id="pet-name-in-subtitle">Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï ÏƒÎ±Ï‚</span> Ï€ÏÎ¹Î½ Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎ¿Ï…Î¼Îµ
            </p>
            
            <!-- Review Cards -->
            <div class="review-section">
                <!-- Pet Basic Info -->
                <div class="review-card">
                    <div class="review-header">
                        <h3>ğŸ¾ Î’Î±ÏƒÎ¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</h3>
                        <button class="edit-btn" id="basic-edit-btn" onclick="toggleEditMode('basic')">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
                    </div>
                    <div class="review-content" id="basic-content">
                        <!-- View Mode -->
                        <div class="view-mode" id="basic-view">
                            <div class="review-item">
                                <strong>ÎŒÎ½Î¿Î¼Î±:</strong>
                                <span id="review-name">-</span>
                            </div>
                            <div class="review-item">
                                <strong>Î¤ÏÏ€Î¿Ï‚:</strong>
                                <span id="review-type">-</span>
                            </div>
                            <div class="review-item">
                                <strong>Î¦ÏÎ»Î¿:</strong>
                                <span id="review-gender">-</span>
                            </div>
                            <div class="review-item">
                                <strong>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î“Î­Î½Î½Î·ÏƒÎ·Ï‚:</strong>
                                <span id="review-birthdate">-</span>
                            </div>
                            <div class="review-item">
                                <strong>Î¡Î¬Ï„ÏƒÎ± & Î’Î¬ÏÎ¿Ï‚:</strong>
                                <span id="review-breed">-</span>
                            </div>
                        </div>
                        
                        <!-- Edit Mode -->
                        <div class="edit-mode" id="basic-edit" style="display: none;">
                            <div class="edit-item">
                                <label><strong>ÎŒÎ½Î¿Î¼Î±:</strong></label>
                                <input type="text" id="edit-name" class="edit-input" placeholder="Î•Î¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î±">
                            </div>
                            <div class="edit-item">
                                <label><strong>Î¤ÏÏ€Î¿Ï‚:</strong></label>
                                <div class="readonly-field" id="edit-type-display">
                                    <span id="type-readonly-text">Î£ÎºÏÎ»Î¿Ï‚ ğŸ•</span>
                                    <small style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î±Î»Î»Î¬Î¾ÎµÎ¹</small>
                                </div>
                            </div>
                            <div class="edit-item">
                                <label><strong>Î¦ÏÎ»Î¿:</strong></label>
                                <select id="edit-gender" class="edit-select">
                                    <option value="male">Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ â™‚ï¸</option>
                                    <option value="female">Î˜Î·Î»Ï…ÎºÏŒ â™€ï¸</option>
                                </select>
                            </div>
                            <div class="edit-item">
                                <label><strong>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î“Î­Î½Î½Î·ÏƒÎ·Ï‚:</strong></label>
                                <input type="text" id="edit-birthdate" class="edit-input" placeholder="Ï€.Ï‡. 15/03/2020">
                            </div>
                            <div class="edit-item">
                                <label><strong>Î¡Î¬Ï„ÏƒÎ±:</strong></label>
                                <input type="text" id="edit-breed" class="edit-input" placeholder="Ï€.Ï‡. Î›Î±Î¼Ï€ÏÎ±Î½Ï„ÏŒÏ">
                            </div>
                            <div class="edit-item">
                                <label><strong>Î’Î¬ÏÎ¿Ï‚:</strong></label>
                                <select id="edit-weight" class="edit-select">
                                    <!-- Options will be populated by JavaScript based on pet type -->
                                </select>
                            </div>
                            
                            <div class="edit-actions">
                                <button class="save-btn" onclick="saveBasicInfo()">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
                                <button class="cancel-btn" onclick="cancelEdit('basic')">âŒ Î‘ÎºÏÏÏ‰ÏƒÎ·</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Health Status -->
                <div class="review-card">
                    <div class="review-header">
                        <h3>ğŸ¥ ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î¥Î³ÎµÎ¯Î±Ï‚</h3>
                        <button class="edit-btn" onclick="editSection('health')">Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±</button>
                    </div>
                    <div class="review-content">
                        <div class="review-item">
                            <strong>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·:</strong>
                            <span id="review-health-status">Î¥Î³Î¹Î­Ï‚ - ÎŒÎ»Î± ÎºÎ±Î»Î¬ âœ…</span>
                        </div>
                        <div class="review-item" id="conditions-item" style="display: none;">
                            <strong>Î ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Î¥Î³ÎµÎ¯Î±Ï‚:</strong>
                            <span id="review-conditions">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="action-buttons" style="margin-top: 3rem;">
                <button class="btn btn-lg btn-success" onclick="proceedToInsurance()" style="padding: 1rem 3rem; border-radius: 15px; font-weight: 600; font-size: 1.1rem;">
                    ğŸš€ Î ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÏ„Îµ ÏƒÏ„Î·Î½ Î‘ÏƒÏ†Î¬Î»Î¹ÏƒÎ·
                </button>
            </div>
            
            <!-- Navigation Buttons -->
            <div class="navigation-buttons" style="margin-top: 2rem;">
                <button class="btn btn-lg btn-light" onclick="goBack()" style="padding: 1rem 2rem; border-radius: 15px; font-weight: 600;">
                    â† Î Î¯ÏƒÏ‰
                </button>
            </div>
        </div>
    </div>
</section>

<script>
let currentData = {};

document.addEventListener('DOMContentLoaded', function() {
    // Get parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    currentData = {
        type: urlParams.get('type') || '',
        gender: urlParams.get('gender') || '',
        birthdate: urlParams.get('birthdate') || '',
        breed: urlParams.get('breed') || '',
        name: urlParams.get('name') || '',
        health_status: urlParams.get('health_status') || '',
        conditions: urlParams.get('conditions') || ''
    };
    
    populateReviewData();
});

function populateReviewData() {
    // Pet name
    if (currentData.name) {
        const petName = decodeURIComponent(currentData.name);
        document.getElementById('review-name').textContent = petName;
        document.getElementById('pet-name-in-subtitle').textContent = `Ï„Î¿Ï… ${petName}`;
    }
    
    // Pet type
    if (currentData.type === 'dog') {
        document.getElementById('review-type').textContent = 'Î£ÎºÏÎ»Î¿Ï‚ ğŸ•';
    } else if (currentData.type === 'cat') {
        document.getElementById('review-type').textContent = 'Î“Î¬Ï„Î± ğŸ±';
    }
    
    // Gender
    if (currentData.gender === 'male') {
        document.getElementById('review-gender').textContent = 'Î‘ÏÏƒÎµÎ½Î¹ÎºÏŒ â™‚ï¸';
    } else if (currentData.gender === 'female') {
        document.getElementById('review-gender').textContent = 'Î˜Î·Î»Ï…ÎºÏŒ â™€ï¸';
    }
    
    // Birthdate
    if (currentData.birthdate) {
        document.getElementById('review-birthdate').textContent = decodeURIComponent(currentData.birthdate);
    }
    
    // Breed
    if (currentData.breed) {
        document.getElementById('review-breed').textContent = decodeURIComponent(currentData.breed);
    }
    
    // Health status
    if (currentData.health_status === 'healthy') {
        document.getElementById('review-health-status').textContent = 'Î¥Î³Î¹Î­Ï‚ - ÎŒÎ»Î± ÎºÎ±Î»Î¬ âœ…';
        document.getElementById('conditions-item').style.display = 'none';
    } else if (currentData.health_status === 'problems') {
        document.getElementById('review-health-status').textContent = 'ÎˆÏ‡ÎµÎ¹ Ï€ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Ï…Î³ÎµÎ¯Î±Ï‚ ğŸ¥';
        if (currentData.conditions) {
            document.getElementById('conditions-item').style.display = 'block';
            document.getElementById('review-conditions').textContent = decodeURIComponent(currentData.conditions);
        }
    }
}

function toggleEditMode(section) {
    if (section === 'basic') {
        const viewMode = document.getElementById('basic-view');
        const editMode = document.getElementById('basic-edit');
        const editBtn = document.getElementById('basic-edit-btn');
        
        if (editMode.style.display === 'none') {
            // Switch to edit mode
            populateEditFields();
            viewMode.style.display = 'none';
            editMode.style.display = 'block';
            editBtn.textContent = 'Î‘ÎºÏÏÏ‰ÏƒÎ·';
            editBtn.onclick = () => cancelEdit('basic');
        } else {
            // Switch back to view mode
            cancelEdit('basic');
        }
    }
}

function populateEditFields() {
    // Populate edit fields with current data
    document.getElementById('edit-name').value = decodeURIComponent(currentData.name || '');
    
    // Set pet type as readonly
    const petType = currentData.type || 'dog';
    if (petType === 'dog') {
        document.getElementById('type-readonly-text').textContent = 'Î£ÎºÏÎ»Î¿Ï‚ ğŸ•';
    } else {
        document.getElementById('type-readonly-text').textContent = 'Î“Î¬Ï„Î± ğŸ±';
    }
    
    document.getElementById('edit-gender').value = currentData.gender || 'male';
    document.getElementById('edit-birthdate').value = decodeURIComponent(currentData.birthdate || '');
    
    // Parse breed and weight from combined field
    const breedInfo = decodeURIComponent(currentData.breed || '');
    const breedMatch = breedInfo.match(/^(.*?)\s*\((.*?)\)$/);
    
    if (breedMatch) {
        document.getElementById('edit-breed').value = breedMatch[1].trim();
        const weightInfo = breedMatch[2].trim();
        populateWeightOptions(petType, weightInfo);
    } else {
        document.getElementById('edit-breed').value = breedInfo;
        populateWeightOptions(petType, '');
    }
}

function populateWeightOptions(petType, currentWeight) {
    const weightSelect = document.getElementById('edit-weight');
    weightSelect.innerHTML = '';
    
    let weightOptions = [];
    
    if (petType === 'dog') {
        weightOptions = [
            { value: 'Î­Ï‰Ï‚ 10 ÎºÎ¹Î»Î¬', text: 'Î­Ï‰Ï‚ 10 ÎºÎ¹Î»Î¬ (ÎœÎ¹ÎºÏÎ¬ ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹Î±)' },
            { value: '11-20 ÎºÎ¹Î»Î¬', text: '11-20 ÎºÎ¹Î»Î¬ (ÎœÎµÏƒÎ±Î¯Î± ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹Î±)' },
            { value: '21-40 ÎºÎ¹Î»Î¬', text: '21-40 ÎºÎ¹Î»Î¬ (ÎœÎµÎ³Î¬Î»Î± ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹Î±)' },
            { value: '>40 ÎºÎ¹Î»Î¬', text: '>40 ÎºÎ¹Î»Î¬ (Î Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î± ÎºÎ±Ï„Î¿Î¹ÎºÎ¯Î´Î¹Î±)' }
        ];
    } else if (petType === 'cat') {
        weightOptions = [
            { value: 'Î­Ï‰Ï‚ 10 ÎºÎ¹Î»Î¬', text: 'Î­Ï‰Ï‚ 10 ÎºÎ¹Î»Î¬ (ÎšÎ±Î½Î¿Î½Î¹ÎºÏŒ Î¼Î­Î³ÎµÎ¸Î¿Ï‚)' },
            { value: '11-20 ÎºÎ¹Î»Î¬', text: '11-20 ÎºÎ¹Î»Î¬ (ÎœÎµÎ³Î¬Î»Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚)' }
        ];
    }
    
    // Add options to select
    weightOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        
        // Select current weight if it matches
        if (currentWeight === option.value) {
            optionElement.selected = true;
        }
        
        weightSelect.appendChild(optionElement);
    });
    
    // If no match found, select first option
    if (!currentWeight || !weightOptions.find(opt => opt.value === currentWeight)) {
        if (weightSelect.options.length > 0) {
            weightSelect.selectedIndex = 0;
        }
    }
}

function saveBasicInfo() {
    // Get values from edit fields
    const newName = document.getElementById('edit-name').value.trim();
    const newGender = document.getElementById('edit-gender').value;
    const newBirthdate = document.getElementById('edit-birthdate').value.trim();
    const newBreed = document.getElementById('edit-breed').value.trim();
    const newWeight = document.getElementById('edit-weight').value;
    
    // Validate required fields
    if (!newName) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î¿ ÏŒÎ½Î¿Î¼Î± Ï„Î¿Ï… ÎºÎ±Ï„Î¿Î¹ÎºÎ¹Î´Î¹Î¿Ï.');
        document.getElementById('edit-name').focus();
        return;
    }
    
    if (!newBirthdate) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î·Î½ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± Î³Î­Î½Î½Î·ÏƒÎ·Ï‚.');
        document.getElementById('edit-birthdate').focus();
        return;
    }
    
    if (!newBreed) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ±Î³Î¬Î³ÎµÏ„Îµ Ï„Î· ÏÎ¬Ï„ÏƒÎ±.');
        document.getElementById('edit-breed').focus();
        return;
    }
    
    if (!newWeight) {
        alert('Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î²Î¬ÏÎ¿Ï…Ï‚.');
        document.getElementById('edit-weight').focus();
        return;
    }
    
    // Combine breed and weight info
    const combinedBreedInfo = `${newBreed} (${newWeight})`;
    
    // Update current data (pet type remains unchanged)
    currentData.name = encodeURIComponent(newName);
    currentData.gender = newGender;
    currentData.birthdate = encodeURIComponent(newBirthdate);
    currentData.breed = encodeURIComponent(combinedBreedInfo);
    
    // Update the display
    populateReviewData();
    
    // Switch back to view mode
    cancelEdit('basic');
    
    // Show success message
    showSuccessMessage('Î¤Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± ÎµÎ½Î·Î¼ÎµÏÏÎ¸Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! âœ…');
}

function cancelEdit(section) {
    if (section === 'basic') {
        const viewMode = document.getElementById('basic-view');
        const editMode = document.getElementById('basic-edit');
        const editBtn = document.getElementById('basic-edit-btn');
        
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        editBtn.textContent = 'Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±';
        editBtn.onclick = () => toggleEditMode('basic');
    }
}

function showSuccessMessage(message) {
    // Create and show a temporary success message
    const successDiv = document.createElement('div');
    successDiv.className = 'success-message';
    successDiv.textContent = message;
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #2ecc71, #27ae60);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
        z-index: 1000;
        font-weight: 600;
        animation: slideInRight 0.3s ease-out;
    `;
    
    document.body.appendChild(successDiv);
    
    // Remove after 3 seconds
    setTimeout(() => {
        successDiv.style.animation = 'slideOutRight 0.3s ease-in';
        setTimeout(() => {
            document.body.removeChild(successDiv);
        }, 300);
    }, 3000);
}

function editSection(section) {
    if (section === 'health') {
        // Go back to health status page
        window.location.href = `{% url 'main:health_status' %}?type=${currentData.type}&gender=${currentData.gender}&birthdate=${encodeURIComponent(currentData.birthdate)}&breed=${encodeURIComponent(currentData.breed)}&name=${encodeURIComponent(currentData.name)}`;
    }
}

function proceedToInsurance() {
    // Navigate to insurance programs page to select a plan
    const params = new URLSearchParams({
        type: currentData.type,
        gender: currentData.gender,
        birthdate: currentData.birthdate,
        breed: currentData.breed,
        name: currentData.name,
        health_status: currentData.health_status,
        conditions: currentData.conditions
    });
    
    window.location.href = `{% url 'main:insurance_programs' %}?${params.toString()}`;
}

function goBack() {
    window.history.back();
}
</script>
{% endblock %}
